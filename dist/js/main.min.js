var LICENSED=true;chrome.app.runtime.onLaunched.addListener(init);chrome.app.runtime.onRestarted.addListener(init);var directoryServer,adminServer,restartTimeout;chrome.commands.onCommand.addListener(function(command){chrome.runtime.sendMessage(null,{command:command},function(response){})});function init(){var win,data;async.series([function(next){if(!LICENSED){next();return}chrome.storage.managed.get(null,function(managedSettings){data=Object.assign({},managedSettings);if(!managedSettings.devices||!managedSettings.devices.length){next();return}chrome.enterprise.deviceAttributes.getDeviceAssetId(function(assetID){if(!assetID){next();return}var deviceConfig=managedSettings.devices.find(function(config){return assetID==config.assetid});if(!deviceConfig){next();return}data=Object.assign({},data,deviceConfig.configuration);next()})})},function(next){chrome.storage.local.get(null,function(localSettings){data=Object.assign({},localSettings,data);next()})},function(next){if(!data.startupdelay){next();return}var startupDelay=parseFloat(data.startupdelay)||0;setTimeout(next,startupDelay*1e3)}],function(err){if(!("url"in data)){openWindow("windows/setup.html");return}if(!data.sleepmode){chrome.storage.local.set({sleepmode:"display"});data.sleepmode="display"}if(data.sleepmode=="none"){chrome.power.releaseKeepAwake()}else{chrome.power.requestKeepAwake(data.sleepmode)}if(data.servelocaldirectory&&data.servelocalhost&&data.servelocalport){chrome.fileSystem.restoreEntry(data.servelocaldirectory,function(entry){if(!entry){restartTimeout=setTimeout(restart,30*1e3);return}var host=data.servelocalhost;var port=data.servelocalport;startWebserverDirectoryEntry(host,port,entry)})}openWindow("windows/browser.html")});function openWindow(path){if(win)win.close();chrome.system.display.getInfo(function(d){chrome.app.window.create(path,{frame:"none",id:"browser",state:"fullscreen",bounds:{left:0,top:0,width:d[0].bounds.width,height:d[0].bounds.height}},function(w){win=w;if(win){win.fullscreen();setTimeout(function(){if(win)win.fullscreen()},1e3)}})})}function startWebserverDirectoryEntry(host,port,entry){directoryServer=new WSC.WebApplication({host:host,port:port,renderIndex:true,optRenderIndex:true,entry:entry});directoryServer.start()}}function stopAutoRestart(){if(restartTimeout){clearTimeout(restartTimeout)}}
