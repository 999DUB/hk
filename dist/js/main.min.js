var LICENSED=false;chrome.app.runtime.onLaunched.addListener(init);chrome.app.runtime.onRestarted.addListener(init);var directoryServer,adminServer,restartTimeout;function init(){var win,basePath,socketInfo;var data={};var filesMap={};async.series([function(next){if(!LICENSED){next();return}chrome.storage.managed.get(null,function(managedSettings){_.defaults(data,managedSettings);next()})},function(next){chrome.storage.local.get(null,function(localSettings){_.defaults(data,localSettings);next()})},function(next){var startupDelay=parseFloat(data.startupdelay)||0;setTimeout(next,startupDelay*1e3)}],function(err){if("url"in data){if(!data.sleepmode){chrome.storage.local.set({sleepmode:"display"});data.sleepmode="display"}if(data.sleepmode=="none"){chrome.power.releaseKeepAwake()}else{chrome.power.requestKeepAwake(data.sleepmode)}if(data.servelocaldirectory&&data.servelocalhost&&data.servelocalport){chrome.fileSystem.restoreEntry(data.servelocaldirectory,function(entry){if(!entry){restartTimeout=setTimeout(restart,30*1e3);return}var host=data.servelocalhost;var port=data.servelocalport;startWebserverDirectoryEntry(host,port,entry)})}if(data.host&&data.port){startWebserver(data.host,data.port,"www",data)}openWindow("windows/browser.html")}else{openWindow("windows/setup.html")}});function openWindow(path){if(win)win.close();chrome.system.display.getInfo(function(d){chrome.app.window.create(path,{frame:"none",id:"browser",state:"fullscreen",bounds:{left:0,top:0,width:d[0].bounds.width,height:d[0].bounds.height}},function(w){win=w;if(win){win.fullscreen();setTimeout(function(){if(win)win.fullscreen()},1e3)}})})}function startWebserverDirectoryEntry(host,port,entry){directoryServer=new WSC.WebApplication({host:host,port:port,renderIndex:true,optRenderIndex:true,entry:entry});directoryServer.start()}function startWebserver(host,port,directory,settings){chrome.runtime.getPackageDirectoryEntry(function(packageDirectory){packageDirectory.getDirectory(directory,{create:false},function(webroot){var fs=new WSC.FileSystem(webroot);var handlers=[["/data.*",AdminDataHandler],[".*",WSC.DirectoryEntryHandler.bind(null,fs)]];adminServer=new WSC.WebApplication({host:host,port:port,handlers:handlers,renderIndex:true,optRenderIndex:true,auth:{username:settings.username,password:settings.password}});adminServer.start()})})}}function restartApplication(){chrome.runtime.restart();chrome.runtime.reload()}function stopAutoRestart(){if(restartTimeout){clearTimeout(restartTimeout)}}function AdminDataHandler(request){WSC.BaseHandler.prototype.constructor.call(this)}var app=this;_.extend(AdminDataHandler.prototype,{put:function(){var newData=this.request.bodyparams;chrome.storage.local.get(null,function(data){var saveData={};var restartNow=false;for(var key in newData){var value=newData[key];if(data.hasOwnProperty(key)){if(key=="url"&&!Array.isArray(value)){value=value.split(",");restart=true}data[key]=value;saveData[key]=value}if(key.toString()=="restart"){restartNow=true}}chrome.storage.local.set(saveData);this.setHeader("content-type","text/json");var buf=new TextEncoder("utf-8").encode(JSON.stringify(data)).buffer;this.write(buf);this.finish();if(restartNow)setTimeout(function(){restartApplication()},1e3)}.bind(this))},get:function(){chrome.storage.local.get(null,function(data){this.setHeader("content-type","text/json");var buf=new TextEncoder("utf-8").encode(JSON.stringify(data)).buffer;this.write(buf);this.finish()}.bind(this))}},WSC.BaseHandler.prototype);
